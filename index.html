<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØµØ§Ø±ÙŠÙÙŠ Pro - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap');
        
        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        :root { 
            --bg: #f0f2f5; 
            --card-bg: #ffffff;
            --input-bg: #f8fafc;
            --input-text: #1e293b;
            --text: #334155; 
            --main-c1: #6366f1;
            --main-c2: #8b5cf6;
            --accent: #10b981;
            --header-grad: linear-gradient(135deg, var(--main-c1), var(--main-c2)); 
            --taskbar-grad: rgba(255, 255, 255, 0.8);
            --border: #e2e8f0; 
            --card-border-color: #f1f5f9;
            --danger: #ef4444;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --acc-card-bg: #ffffff;
        }

        .dark-mode { 
            --bg: #020617; 
            --card-bg: #0f172a; 
            --input-bg: #1e293b;
            --input-text: #f8fafc;
            --text: #cbd5e1; 
            --border: #1e293b;
            --card-border-color: #334155;
            --header-grad: linear-gradient(135deg, #1e1b4b, #312e81); 
            --taskbar-grad: rgba(2, 6, 23, 0.85); 
            --acc-card-bg: #0f172a;
            --main-c1: #818cf8;
            --main-c2: #a78bfa;
        }

        [id^="items-"], 
        #installmentsList, 
        #goalSubBody, 
        #fixedList, 
        #debtEntries {
            max-height: 250px; 
            overflow-y: auto;
            padding-left: 5px;
            padding-right: 5px;
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--main-c1); border-radius: 10px; }

        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .ghost-mode b, .ghost-mode #grandTotal, .ghost-mode #remainingBudget, .ghost-mode .expense-item b, .ghost-mode .goal-val { filter: blur(12px); pointer-events: none; }

        .settled { opacity: 0.5; text-decoration: line-through; background: rgba(0,0,0,0.05); border-radius: 10px; }

        /* ØªØ¹Ø¯ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¯ÙŠÙˆÙ† Ù„ÙŠÙƒÙˆÙ† ØµØ§Ø±Ø®Ø§Ù‹ */
        @keyframes pulse-red-strong {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); background: rgba(239, 68, 68, 0.1); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); background: rgba(239, 68, 68, 0.2); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); background: rgba(239, 68, 68, 0.1); }
        }
        .debt-alert { 
            animation: pulse-red-strong 1.5s infinite; 
            border: 2px solid var(--danger) !important; 
            font-weight: bold;
        }

        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--header-grad); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; text-align: center;
        }

        .taskbar { 
            width: 100%; max-width: 450px; padding: 12px 20px; 
            background: var(--taskbar-grad); 
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border);
        }

        .nav-tool { 
            background: var(--card-bg); color: var(--text); border: 1px solid var(--border);
            border-radius: 12px; width: 42px; height: 42px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; font-size: 18px;
            box-shadow: var(--card-shadow);
        }
        .nav-tool:hover { background: var(--main-c1); color: white; transform: translateY(-2px); }

        .app-container { width: 100%; max-width: 450px; padding-bottom: 40px; display: none; }
        .day-card { background: var(--card-bg); border-radius: 24px; margin: 15px; box-shadow: var(--card-shadow); overflow: hidden; border: 1px solid var(--card-border-color) !important; }
        .day-header { padding: 20px 24px; display: flex; justify-content: space-between; cursor: pointer; font-weight: 700; color: white; background: var(--header-grad); }
        .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-bottom: 1px solid var(--border); }
        .btn-delete-fancy { background: #fee2e2; color: var(--danger); border: none; font-size: 16px; cursor: pointer; padding: 8px; border-radius: 10px; margin-right: 5px; }
        .btn-delete-fancy:hover { background: var(--danger); color: white; }
        
        .brand-card { background: var(--header-grad); color: white; margin: 20px 15px; padding: 30px 25px; border-radius: 32px; text-align: center; box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 15px; }
        .stat-card { background: var(--card-bg); padding: 18px 12px; border-radius: 24px; text-align: center; box-shadow: var(--card-shadow); border: 1px solid var(--border); cursor: pointer; }
        .stat-card span { font-size: 13px; color: #64748b; font-weight: 600; }
        .stat-card b { font-size: 18px; display: block; margin-top: 5px; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(15, 23, 42, 0.6); backdrop-filter:blur(8px); display:none; justify-content:center; align-items:center; z-index: 9999; }
        
        .modal-content { 
            background:var(--card-bg); 
            padding:35px; 
            border-radius:32px; 
            width:92%; 
            max-width:400px; 
            text-align:center; 
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        input, select { padding: 14px; border: 2px solid var(--border); border-radius: 14px; margin-bottom: 12px; width: 100%; text-align: center; font-family: 'Tajawal'; font-weight: 600; outline: none; background: var(--input-bg); color: var(--input-text); }
        input:focus { border-color: var(--main-c1); background: #fff; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        .dark-mode input:focus { background: var(--input-bg); border-color: var(--main-c1); }

        .btn-add-pro { padding: 14px 30px; background: var(--main-c1); color: white; border: none; border-radius: 16px; font-weight: 800; cursor: pointer; margin: 10px auto; display: block; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4); }
        .btn-add-pro:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4); }

        .cat-btn { 
            border: 1px solid var(--border); 
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 10px 18px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 700; 
            white-space: nowrap; 
            color: var(--text);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .cat-btn:hover { background: var(--main-c1); color: white; border-color: var(--main-c1); }

        .toggle-card { background: var(--bg); border-radius: 18px; margin-top: 12px; overflow: hidden; border: 1px solid var(--border); }
        .toggle-header { padding: 15px; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; background: var(--input-bg); color: var(--text); }
        .toggle-body { padding: 18px; display: none; background: var(--card-bg); }

        .accumulated-card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 24px; 
            text-align: center; 
            border: 2px dashed var(--main-c1);
            margin: 15px;
        }

        .ai-banner { font-size: 13px; font-weight: 600; padding: 12px; border-radius: 16px; margin-top: 15px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); }
        
        .btn-mini-plus {
            background: var(--accent); color: white; border: none; border-radius: 12px;
            width: 45px; height: 45px; font-size: 20px; cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4);
        }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© */
        .calc-icon {
            position: absolute;
            left: 10px;
            top: 15px;
            font-size: 14px;
            cursor: pointer;
            opacity: 0.6;
        }
    </style>
</head>
<body onload="initLock()">

<div id="lockScreen" class="animate__animated animate__fadeIn">
    <div style="background: rgba(255,255,255,0.2); padding: 30px; border-radius: 50%; margin-bottom: 20px;">
        <h1 id="lockLogo" style="font-size: 60px; margin:0;">ğŸ’</h1>
    </div>
    <h2 id="lockName" style="font-weight: 800; letter-spacing: 1px;">Ù…ØµØ§Ø±ÙŠÙÙŠ PRO</h2>
    <p style="opacity: 0.8; font-size: 14px; margin-bottom: 25px;">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
    <input type="password" id="pinInput" placeholder="****" style="width: 150px; font-size: 28px; letter-spacing: 8px; border:none; background: rgba(255,255,255,0.9);" maxlength="4">
    <button onclick="unlockApp()" class="btn-add-pro" style="background: #fff; color: var(--main-c1); width: 150px; font-size: 18px;">Ø¯Ø®ÙˆÙ„</button>
</div>

<div class="taskbar">
    <button onclick="toggleTheme()" class="nav-tool">ğŸŒ™</button>
    <div style="font-weight: 900; color: var(--main-c1); font-size: 18px;">Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
    <div style="display:flex; gap:10px;">
        <button onclick="toggleGhostMode()" class="nav-tool">ğŸ‘ï¸</button>
        <button onclick="toggleSearch()" class="nav-tool">ğŸ”</button>
        <button onclick="openSettings()" class="nav-tool">âš™ï¸</button>
    </div>
</div>

<div class="app-container animate__animated animate__fadeIn" id="captureArea">
    <div class="brand-card animate__animated animate__slideInDown">
        <h2 onclick="editBrandName()" style="margin:0; font-weight: 900; font-size: 28px; cursor: pointer;">
             <span id="appLogo">ğŸ’</span> <span id="appNameDisplay">Ù…ØµØ§Ø±ÙŠÙÙŠ Pro</span>
        </h2>
        <div style="background: rgba(255,255,255,0.12); margin-top: 25px; padding: 20px; border-radius: 24px; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                <span style="font-size:13px; font-weight: 700; opacity: 0.9;">Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</span>
                <span id="savingStatus" style="font-size:12px; background:rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 8px;">Ù Ùª</span>
            </div>
            <div style="height:12px; background:rgba(255,255,255,0.2); border-radius:10px; margin: 10px 0;"><div id="barFill" style="height:100%; background:#fff; width:0%; border-radius:10px; box-shadow: 0 0 10px #fff;"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight: 800;"><span id="remainingBudget">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: Ù </span></div>
            <div id="dailyAdvice" class="ai-banner" style="background: rgba(0,0,0,0.15); border:none; text-align: right;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
            <div id="aiAnalysis" class="ai-banner"></div>
            <div id="instReminder" style="background:#fef08a; color:#854d0e; padding:10px; border-radius:12px; margin-top:10px; font-size:12px; font-weight:bold; display:none;"></div>
        </div>
    </div>

    <div class="day-card" style="padding: 20px;">
        <div style="font-weight: 800; margin-bottom: 15px; color: var(--main-c1); display: flex; align-items: center; gap: 8px;">
            <span>ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</span>
        </div>
        <canvas id="weeklyChart" style="max-height: 180px;"></canvas>
        <hr style="border: 0.5px solid var(--border); margin: 20px 0;">
        <div style="height: 200px;">
            <canvas id="categoryChart"></canvas>
        </div>
    </div>

    <div id="searchBar" style="padding:0 20px; display:none; margin-bottom:10px;"><input type="text" id="globalSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ..." oninput="updateUI()"></div>

    <div class="stat-grid">
        <div class="stat-card"><span>Ø£Ø¹Ù„Ù‰ ÙŠÙˆÙ… ØµØ±Ù</span><b id="topDay" style="color:var(--main-c1)">---</b></div>
        <div class="stat-card"><span>Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span><b id="avgSpend">Ù </b></div>
        <div class="stat-card" onclick="openDebtModal('debt')"><span>Ø¯ÙŠÙˆÙ† Ø¨Ø°Ù…ØªÙƒ ğŸ§¾</span><b id="debtVal" style="color:var(--danger)">Ù </b></div>
        <div class="stat-card" onclick="openDebtModal('credit')"><span>Ø¯ÙŠÙˆÙ† ØªØ·Ù„Ø¨Ù‡Ø§ ğŸ’¸</span><b id="creditVal" style="color:var(--accent)">Ù </b></div>
    </div>

    <div class="day-card">
        <div class="day-header" onclick="toggleSection('allDaysSectionBody')">
            <span>ğŸ“ Ø³Ø¬Ù„ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø£ÙŠØ§Ù… â–¾</span>
            <small style="font-size: 11px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 8px;">Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ø¯ÙŠØ¯</small>
        </div>
        <div id="allDaysSectionBody" style="display:none; padding:10px;" class="animate__animated animate__fadeIn">
            <div id="daysList"></div> </div>
    </div>

    <div class="day-card" style="border: 2px solid var(--main-c1) !important;">
        <div class="day-header" style="background: var(--header-grad);" onclick="toggleSection('financialCenterBody')">
            <span>ğŸ’° Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø§Ø¯Ø®Ø§Ø± â–¾</span>
        </div>
        <div id="financialCenterBody" style="display:none; padding:15px;" class="animate__animated animate__fadeIn">
            
            <div class="toggle-card">
                <div class="toggle-header" onclick="toggleElement('instSubBody')">ğŸ“… Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø© <span>â–¾</span></div>
                <div id="instSubBody" class="toggle-body">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <input type="text" id="instDesc" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ø·">
                        <input type="text" id="instAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© 1+1)">
                        <input type="number" id="instDay" placeholder="ÙŠÙˆÙ… Ø§Ù„Ø¯ÙØ¹ (1-31)">
                        <input type="number" id="instMonths" placeholder="Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©">
                    </div>
                    <button onclick="addInstallment()" class="btn-add-pro" style="width:100%; margin-top:5px;">ØªØ«Ø¨ÙŠØª Ø§Ù„Ù‚Ø³Ø·</button>
                    <div id="installmentsList"></div>
                </div>
            </div>

            <div class="toggle-card">
                <div class="toggle-header" onclick="toggleElement('goalSubBody')">ğŸ¯ Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø§Ø¯Ø®Ø§Ø± <span>â–¾</span></div>
                <div id="goalSubBody" class="toggle-body">
                    <div id="goalProgressArea">
                        <div id="goalEmptyState" style="text-align:center; padding: 20px; opacity:0.6;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‡Ø¯Ø§Ù Ù†Ø´Ø·Ø©</div>
                        <div id="goalActiveState" style="display:none;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <b id="activeGoalName" style="color:var(--main-c1); font-size:18px;">---</b>
                                <span id="activeGoalPercent" style="background:var(--accent); color:white; padding:2px 10px; border-radius:20px; font-size:12px;">0%</span>
                            </div>
                            <div style="height:14px; background:#e2e8f0; border-radius:10px; margin-bottom:15px; overflow:hidden;">
                                <div id="goalFill" style="height:100%; background:linear-gradient(to left, var(--accent), #34d399); width:0%;"></div>
                            </div>
                            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:15px; font-weight:700;">
                                <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <b class="goal-val" id="goalCurrent">0</b></span>
                                <span>Ø§Ù„Ù‡Ø¯Ù: <b class="goal-val" id="goalTarget">0</b></span>
                            </div>
                            <div style="display:grid; grid-template-columns: 1fr auto; gap:10px; align-items: center;">
                                <input type="text" id="addGoalAmt" placeholder="Ø£Ø¶Ù Ù…Ø¨Ù„Øº (ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© 1+1)" style="margin:0;">
                                <button onclick="addToGoal()" class="btn-mini-plus">â•</button>
                            </div>
                            <button onclick="resetGoal()" style="background:none; border:none; color:var(--danger); font-size:12px; width:100%; cursor:pointer; margin-top:15px; font-weight:700;">âŒ Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù‡Ø¯Ù</button>
                        </div>
                    </div>
                    <button id="btnNewGoal" onclick="document.getElementById('newGoalModal').style.display='flex'" class="btn-add-pro" style="width:100%; background: var(--accent);">+ Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯</button>
                </div>
            </div>

            <div class="toggle-card">
                <div class="toggle-header" onclick="toggleElement('safeSubBody')">ğŸ”’ Ø§Ù„Ø®Ø²Ù†Ø© (Ù…ØµØ§Ø±ÙŠÙ Ø«Ø§Ø¨ØªØ©) <span>â–¾</span></div>
                <div id="safeSubBody" class="toggle-body">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="text" id="fixedDesc" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¥ÙŠØ¬Ø§Ø±">
                        <input type="text" id="fixedAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                    </div>
                    <button onclick="addFixedExpense()" class="btn-add-pro" style="width:100%; background: #475569;">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø®Ø²Ù†Ø©</button>
                    <div id="fixedList" style="margin-top:15px;"></div>
                </div>
            </div>

            <div class="toggle-card" id="debtDetailsContainer" style="display:none;">
                <div class="toggle-header" onclick="toggleElement('debtSubBody')">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø¯ÙŠØ§Ù†Ø© <span>â–¾</span></div>
                <div id="debtSubBody" class="toggle-body">
                    <div id="debtEntries"></div>
                </div>
            </div>

        </div>
    </div>

    <div class="accumulated-card">
        <span style="color: #64748b; font-size: 13px; font-weight: 700; display: block; margin-bottom: 5px;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ</span>
        <div id="accumulatedTotal" style="font-size:26px; font-weight: 900; color: var(--main-c1);">Ù  Ø¯.Ø¹</div>
    </div>

    <div style="margin: 20px 15px; background:var(--header-grad); color:white; padding:25px; border-radius:32px; text-align:center;">
        <span style="opacity: 0.8; font-size: 14px; font-weight: 600;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</span>
        <div id="grandTotal" style="font-size:32px; font-weight: 900; margin-top: 5px;">Ù  Ø¯.Ø¹</div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-content animate__animated animate__zoomIn" style="max-height: 85vh; overflow-y: auto;">
        <h3 style="color:var(--main-c1); margin-top:0;">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
        <p style="font-size: 14px; font-weight: 700; margin-bottom:10px;">ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</p>
        <input type="number" id="budgetLimit" placeholder="Ø­Ø¯Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ Ø§Ù„ÙƒÙ„ÙŠØ©" oninput="updateUI()">
        
        <div class="toggle-card" style="text-align: right;">
            <div class="toggle-header" onclick="toggleElement('toolsBody')">ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ØªØ®ØµÙŠØµ <span>â–¾</span></div>
            <div id="toolsBody" class="toggle-body">
                <p style="font-size: 13px; font-weight: bold; margin-bottom:15px;">ğŸ¨ Ø«ÙŠÙ…Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù†</p>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                    <div style="width:100%; aspect-ratio:1; border-radius:15px; cursor:pointer; background:#6366f1; border:3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="applyColor('#6366f1', '#8b5cf6')"></div>
                    <div style="width:100%; aspect-ratio:1; border-radius:15px; cursor:pointer; background:#10b981; border:3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="applyColor('#10b981', '#059669')"></div>
                    <div style="width:100%; aspect-ratio:1; border-radius:15px; cursor:pointer; background:#f59e0b; border:3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="applyColor('#f59e0b', '#d97706')"></div>
                    
                    <div style="width:100%; aspect-ratio:1; border-radius:15px; cursor:pointer; background:#ef4444; border:3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="applyColor('#ef4444', '#b91c1c')"></div>
                    <div style="width:100%; aspect-ratio:1; border-radius:15px; cursor:pointer; background:#06b6d4; border:3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="applyColor('#06b6d4', '#0891b2')"></div>
                    <div style="width:100%; aspect-ratio:1; border-radius:15px; cursor:pointer; background:#ec4899; border:3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="applyColor('#ec4899', '#be185d')"></div>
                    <div style="width:100%; aspect-ratio:1; border-radius:15px; cursor:pointer; background:#334155; border:3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="applyColor('#334155', '#1e293b')"></div>
                    <div style="width:100%; aspect-ratio:1; border-radius:15px; cursor:pointer; background:#8b5cf6; border:3px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" onclick="applyColor('#8b5cf6', '#6d28d9')"></div>
                </div>
                <button onclick="openPinModal()" class="btn-add-pro" style="width:100%; background:#f59e0b; margin-bottom:10px;">ğŸ” ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…Ø²</button>
                <button onclick="exportAsImage()" class="btn-add-pro" style="width:100%;background:#3b82f6">ğŸ“¸ ØªØµØ¯ÙŠØ± ØµÙˆØ±Ø©</button>
                <button onclick="backupData()" class="btn-add-pro" style="width:100%;background:#10b981">ğŸ“¥ Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                <button onclick="document.getElementById('fileInput').click()" class="btn-add-pro" style="width:100%;background:#818cf8">ğŸ“¤ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø©</button>
                <input type="file" id="fileInput" style="display:none" onchange="restoreData(event)">
                <button onclick="resetWeek()" class="btn-add-pro" style="width:100%;background:#ef4444">ğŸ›‘ ØªØµÙÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</button>
            </div>
        </div>
        <button onclick="closeSettings()" class="btn-add-pro" style="width:100%;background:#94a3b8; margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="newGoalModal" class="modal-overlay"><div class="modal-content animate__animated animate__zoomIn"><h3>ğŸ¯ Ù‡Ø¯Ù Ø§Ø¯Ø®Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3><input type="text" id="newGoalName" placeholder="Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªØ´ØªØ±ÙŠØŸ"><input type="text" id="newGoalTarget" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"><button onclick="saveNewGoal()" class="btn-add-pro">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</button><button onclick="document.getElementById('newGoalModal').style.display='none'" class="btn-add-pro" style="background:#94a3b8">Ø¥Ù„ØºØ§Ø¡</button></div></div>
<div id="pinModal" class="modal-overlay"><div class="modal-content animate__animated animate__zoomIn"><h3>ğŸ” Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯</h3><input type="password" id="newPinInput" maxlength="4" placeholder="****"><button onclick="saveNewPin()" class="btn-add-pro">Ø­ÙØ¸</button><button onclick="document.getElementById('pinModal').style.display='none'" class="btn-add-pro" style="background:#94a3b8">Ø¥Ù„ØºØ§Ø¡</button></div></div>
<div id="debtModal" class="modal-overlay"><div class="modal-content animate__animated animate__zoomIn"><h3 id="debtTitle">Ø³Ø¬Ù„ Ø¯ÙŠÙ†</h3><input type="text" id="debtName" placeholder="Ø§Ù„Ø§Ø³Ù…"><div style="position:relative;"><input type="text" id="debtAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"><span class="calc-icon">ğŸ–©</span></div><button onclick="saveDebtRecord()" class="btn-add-pro">Ø¥Ø¶Ø§ÙØ©</button><button onclick="closeDebtModal()" class="btn-add-pro" style="background:#94a3b8">Ø¥Ù„ØºØ§Ø¡</button></div></div>
<div id="editBrandModal" class="modal-overlay"><div class="modal-content animate__animated animate__zoomIn"><h3>ğŸ¨ ØªØ®ØµÙŠØµ Ø§Ù„Ù‡ÙˆÙŠØ©</h3><input type="text" id="newNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯"><input type="text" id="newLogoInput" placeholder="Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ø¥ÙŠÙ…ÙˆØ¬ÙŠ)"><button onclick="saveBrand()" class="btn-add-pro">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button><button onclick="closeEditBrandModal()" class="btn-add-pro" style="background:#94a3b8">Ø¥Ù„ØºØ§Ø¡</button></div></div>

<script>
    const days = ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©'];
    let currentDebtMode = '';
    let myChart;
    let myCatChart; 

    const autoIcons = {
        'Ø·Ø¹Ø§Ù…': 'ğŸ´', 'Ø§ÙƒÙ„': 'ğŸ´', 'ØºØ¯Ø§Ø¡': 'ğŸ´', 'Ø¹Ø´Ø§Ø¡': 'ğŸ´', 'Ø±ÙŠÙˆÙ‚': 'ğŸ´',
        'Ù†Ù‚Ù„': 'ğŸš—', 'ØªÙƒØ³ÙŠ': 'ğŸš—', 'Ø¨Ù†Ø²ÙŠÙ†': 'ğŸš—', 'Ø³ÙŠØ§Ø±Ø©': 'ğŸš—',
        'ØªØ³ÙˆÙ‚': 'ğŸ›’', 'Ù…Ø³ÙˆØ§Ùƒ': 'ğŸ›’', 'Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª': 'ğŸ›’',
        'Ø±ØµÙŠØ¯': 'ğŸ“±', 'Ù†Øª': 'ğŸ“±', 'Ø§Ù†ØªØ±Ù†Øª': 'ğŸ“±', 'ÙƒØ§Ø±Øª': 'ğŸ“±',
        'Ù…Ù†Ø²Ù„': 'ğŸ ', 'Ø¨ÙŠØª': 'ğŸ ', 'Ø§ÙŠØ¬Ø§Ø±': 'ğŸ ',
        'ÙƒÙˆÙÙŠ': 'â˜•', 'Ù‚Ù‡ÙˆØ©': 'â˜•', 'Ø´Ø§ÙŠ': 'â˜•',
        'ØµØ­Ø©': 'ğŸ’Š', 'Ø¯ÙˆØ§Ø¡': 'ğŸ’Š', 'Ù…Ø³ØªØ´ÙÙ‰': 'ğŸ’Š',
        'Ù‡Ø¯Ø§ÙŠØ§': 'ğŸ', 'Ù‡Ø¯ÙŠØ©': 'ğŸ'
    };

    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠØ©
    function safeEval(val) {
        try {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø£ÙŠ Ø±Ù…ÙˆØ² ØºÙŠØ± Ø­Ø³Ø§Ø¨ÙŠØ© ÙˆØ§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ø¨Ù€ ( + - * / )
            const cleanVal = String(val).replace(/[^-+*/0-9.]/g, '');
            return Function(`'use strict'; return (${cleanVal})`)() || 0;
        } catch (e) {
            return parseFloat(val) || 0;
        }
    }

    // ÙˆØ¸ÙŠÙØ© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    function autoDarkCheck() {
        const hour = new Date().getHours();
        const isNight = hour >= 19 || hour <= 7; // Ù…Ù† 7 Ù…Ø³Ø§Ø¡Ù‹ Ù„Ù€ 7 ØµØ¨Ø§Ø­Ø§Ù‹
        if (isNight && !document.body.classList.contains('dark-mode')) {
            document.body.classList.add('dark-mode');
        }
    }

    // Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    function setupNotifications() {
        if ("Notification" in window) {
            Notification.requestPermission();
        }
    }

    function checkReminder() {
        const now = new Date();
        if (now.getHours() === 21 && now.getMinutes() === 0) { // ØªØ°ÙƒÙŠØ± Ø§Ù„Ø³Ø§Ø¹Ø© 9 Ù…Ø³Ø§Ø¡Ù‹
            if (Notification.permission === "granted") {
                new Notification("ğŸ’ ØªØ°ÙƒÙŠØ± Ù…ØµØ§Ø±ÙŠÙÙŠ PRO", {
                    body: "Ù„Ø§ ØªÙ†Ø³Ù ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙŠÙˆÙ… Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¯Ù‚Ø© Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ!",
                    icon: "https://cdn-icons-png.flaticon.com/512/2454/2454282.png"
                });
            }
        }
    }

    function initLock() {
        if(!localStorage.getItem('appPin')) localStorage.setItem('appPin', '0000');
        document.getElementById('appNameDisplay').innerText = localStorage.getItem('customAppName') || "Ù…ØµØ§Ø±ÙŠÙÙŠ Pro";
        document.getElementById('appLogo').innerText = localStorage.getItem('customAppLogo') || "ğŸ’";
        document.getElementById('budgetLimit').value = localStorage.getItem('myBudget') || 0;
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        autoDarkCheck();
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
        
        applyColor(localStorage.getItem('userC1') || '#6366f1', localStorage.getItem('userC2') || '#8b5cf6');
        processInstallments();
        setupNotifications();
        setInterval(checkReminder, 60000); // ÙØ­Øµ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
        updateUI();
    }

    function unlockApp() {
        if(document.getElementById('pinInput').value === localStorage.getItem('appPin')) {
            document.getElementById('lockScreen').style.display = 'none';
            document.querySelector('.app-container').style.display = 'block';
            checkLock();
            updateChart();
        } else { alert("Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­!"); }
    }

    function toggleSection(id) { 
        const el = document.getElementById(id); 
        el.style.display = (el.style.display === 'none') ? 'block' : 'none'; 
    }
    
    function toggleElement(id) { 
        const el = document.getElementById(id); 
        el.style.display = (el.style.display === 'block') ? 'none' : 'block'; 
        if(el.style.display === 'block') el.classList.add('animate__animated', 'animate__fadeInDown', 'animate__faster');
    }

    function toAr(n) { return (n || 0).toLocaleString('ar-EG') + " Ø¯.Ø¹"; }

    function addInstallment() {
        const desc = document.getElementById('instDesc').value, 
              amtVal = document.getElementById('instAmt').value, 
              day = parseInt(document.getElementById('instDay').value), 
              months = parseInt(document.getElementById('instMonths').value);
        
        const amt = safeEval(amtVal);
        if(!desc || !amt || !day || !months) { alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒØ§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø³Ø·"); return; }
        
        let insts = JSON.parse(localStorage.getItem('installments')) || [];
        insts.push({ desc, amt, day, months, lastPaidMonth: -1 });
        localStorage.setItem('installments', JSON.stringify(insts));
        document.getElementById('instDesc').value = ''; document.getElementById('instAmt').value = ''; document.getElementById('instDay').value = ''; document.getElementById('instMonths').value = '';
        updateUI();
    }

    function processInstallments() {
        const now = new Date(), currentDay = now.getDate(), currentMonth = now.getMonth();
        let insts = JSON.parse(localStorage.getItem('installments')) || [], updated = false;
        insts.forEach(inst => {
            if (currentDay >= inst.day && inst.lastPaidMonth !== currentMonth && inst.months > 0) {
                const dayIdx = (now.getDay() + 1) % 7; 
                let dayData = JSON.parse(localStorage.getItem(`dayData_${dayIdx}`)) || [];
                dayData.push({ desc: `ğŸ’³ Ù‚Ø³Ø·: ${inst.desc}`, amount: inst.amt });
                localStorage.setItem(`dayData_${dayIdx}`, JSON.stringify(dayData));
                inst.months -= 1; inst.lastPaidMonth = currentMonth;
                updated = true;
            }
        });
        if (updated) localStorage.setItem('installments', JSON.stringify(insts));
    }

    function deleteInstallment(idx) { if(confirm("Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ø·ØŸ")) { let insts = JSON.parse(localStorage.getItem('installments')); insts.splice(idx, 1); localStorage.setItem('installments', JSON.stringify(insts)); updateUI(); } }

    function updateChart() {
        const ctx = document.getElementById('weeklyChart').getContext('2d');
        const dataSums = days.map((_, i) => { const data = JSON.parse(localStorage.getItem(`dayData_${i}`)) || []; return data.reduce((s, it) => s + it.amount, 0); });
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: days, datasets: [{ label: 'Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ', data: dataSums, backgroundColor: 'rgba(99, 102, 241, 0.6)', borderColor: '#6366f1', borderWidth: 2, borderRadius: 8 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
        });
    }

    function handleAutoIcon(idx) {
        const input = document.getElementById(`desc-${idx}`), val = input.value;
        for (let key in autoIcons) { if (val.includes(key) && !val.includes(autoIcons[key])) { input.value = autoIcons[key] + " " + val; break; } }
    }

    function addFixedExpense() {
        const desc = document.getElementById('fixedDesc').value, amtVal = document.getElementById('fixedAmt').value;
        const amt = safeEval(amtVal);
        if(!desc || !amt) return;
        let fixed = JSON.parse(localStorage.getItem('fixedExpenses')) || [];
        fixed.push({desc, amt});
        localStorage.setItem('fixedExpenses', JSON.stringify(fixed));
        document.getElementById('fixedDesc').value = ''; document.getElementById('fixedAmt').value = '';
        updateUI();
    }

    function updateUI() {
        let total = 0, maxV = 0, maxD = "---", daysWithExpenses = 0, cumulative = 0;
        const search = document.getElementById('globalSearch').value.toLowerCase(), catTotals = {}; 
        days.forEach((day, i) => {
            const data = JSON.parse(localStorage.getItem(`dayData_${i}`)) || [];
            let dSum = 0;
            const cont = document.getElementById(`items-${i}`);
            if(cont) {
                cont.innerHTML = data.filter(it => it.desc.toLowerCase().includes(search)).map((it, j) => `
                    <div class="expense-item animate__animated animate__fadeIn">
                        <span onclick="editItem(${i}, ${j})" style="cursor:pointer; flex:1; font-weight:600;">${it.desc}</span>
                        <div style="display:flex; align-items:center;">
                            <b style="color:var(--main-c1);">${toAr(it.amount)}</b>
                            <button onclick="deleteItem(${i}, ${j})" class="btn-delete-fancy">ğŸ—‘ï¸</button>
                        </div>
                    </div>`).join('');
                data.forEach(it => { total += it.amount; dSum += it.amount; cumulative += it.amount;
                    let cat = it.desc.split(' ')[0] || 'Ø¹Ø§Ù…';
                    catTotals[cat] = (catTotals[cat] || 0) + it.amount;
                });
                document.getElementById(`dayTotal-${i}`).innerText = toAr(dSum);
                if(dSum > 0) daysWithExpenses++;
                if(dSum > maxV) { maxV = dSum; maxD = day; }
            }
        });
        
        const instData = JSON.parse(localStorage.getItem('installments')) || [];
        document.getElementById('installmentsList').innerHTML = instData.map((x, i) => `
            <div class="animate__animated animate__fadeIn" style="background:var(--input-bg); padding:12px; border-radius:15px; margin-bottom:10px; border-right:4px solid var(--main-c2);">
                <div style="display:flex; justify-content:space-between;"><b>${x.desc}</b><button onclick="deleteInstallment(${i})" style="background:none; border:none; color:red; cursor:pointer;">Ã—</button></div>
                <div style="display:flex; justify-content:space-between; font-size:11px; margin-top:5px; color:#64748b;"><span>Ø§Ù„Ù‚Ø³Ø·: ${toAr(x.amt)}</span><span>ÙŠÙˆÙ…: ${x.day}</span><span>Ø¨Ø§Ù‚ÙŠ: ${x.months} Ø´Ù‡Ø±</span></div>
            </div>`).join('');

        let fixedData = JSON.parse(localStorage.getItem('fixedExpenses')) || [];
        total += fixedData.reduce((s, i) => s + i.amt, 0);
        document.getElementById('fixedList').innerHTML = fixedData.map((x, i) => 
            `<div class="animate__animated animate__fadeIn" style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--border)"><span>ğŸ“Œ ${x.desc}</span> <b>${toAr(x.amt)}</b>
                <button onclick="if(confirm('Ø­Ø°ÙØŸ')){let f=JSON.parse(localStorage.getItem('fixedExpenses'));f.splice(${i},1);localStorage.setItem('fixedExpenses',JSON.stringify(f));updateUI();}" style="background:none;border:none;color:red;cursor:pointer;">Ã—</button></div>`).join('');

        document.getElementById('grandTotal').innerText = toAr(total);
        document.getElementById('accumulatedTotal').innerText = toAr(cumulative);
        document.getElementById('topDay').innerText = maxD;
        document.getElementById('avgSpend').innerText = toAr(Math.round(total / (daysWithExpenses || 1)));
        
        const b = parseFloat(document.getElementById('budgetLimit').value) || 0;
        localStorage.setItem('myBudget', b);
        const pc = b > 0 ? (total/b)*100 : 0, fillEl = document.getElementById('barFill');
        fillEl.style.width = Math.min(pc, 100) + "%";
        if(pc >= 90) fillEl.style.background = "var(--danger)"; else if(pc >= 70) fillEl.style.background = "#f59e0b"; else fillEl.style.background = "#fff";
        document.getElementById('savingStatus').innerText = Math.round(pc) + "%";
        document.getElementById('remainingBudget').innerText = "Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: " + toAr(b - total);
        
        const now = new Date(), lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate(), daysLeft = lastDayOfMonth - now.getDate() + 1;
        document.getElementById('dailyAdvice').innerText = `Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${toAr(Math.round(b > total ? (b - total) / daysLeft : 0))} (Ø¨Ø§Ù‚ÙŠ ${daysLeft} ÙŠÙˆÙ…)`;
        
        const goalData = JSON.parse(localStorage.getItem('myGoal'));
        if(goalData) {
            document.getElementById('goalEmptyState').style.display = 'none'; document.getElementById('goalActiveState').style.display = 'block'; document.getElementById('btnNewGoal').style.display = 'none';
            document.getElementById('activeGoalName').innerText = goalData.name; document.getElementById('goalTarget').innerText = toAr(goalData.target); document.getElementById('goalCurrent').innerText = toAr(goalData.current);
            document.getElementById('goalFill').style.width = Math.min((goalData.current / goalData.target) * 100, 100) + "%";
            document.getElementById('activeGoalPercent').innerText = Math.round((goalData.current / goalData.target) * 100) + "%";
        } else { document.getElementById('goalEmptyState').style.display = 'block'; document.getElementById('goalActiveState').style.display = 'none'; document.getElementById('btnNewGoal').style.display = 'block'; }
        
        const debtData = JSON.parse(localStorage.getItem('debt_debt')) || [], creditData = JSON.parse(localStorage.getItem('debt_credit')) || [];
        document.getElementById('debtVal').innerText = toAr(debtData.filter(x=>!x.settled).reduce((s,i)=>s+i.amount,0));
        document.getElementById('creditVal').innerText = toAr(creditData.filter(x=>!x.settled).reduce((s,i)=>s+i.amount,0));
        
        const dEntries = document.getElementById('debtEntries'), oneWeek = 7 * 24 * 60 * 60 * 1000;
        if(debtData.length || creditData.length) {
            document.getElementById('debtDetailsContainer').style.display = 'block';
            dEntries.innerHTML = [
                ...debtData.map((x,idx)=>`<div class="expense-item animate__animated animate__fadeIn ${x.settled ? 'settled' : ''} ${(x.date && (new Date() - new Date(x.date)) > oneWeek && !x.settled) ? 'debt-alert' : ''}" style="color:var(--danger)"><span>${x.settled ? 'âœ”ï¸' : ''} Ø¹Ù„ÙŠÙƒ Ù„Ù€ ${x.name} <br><small style="font-size:10px; opacity:0.7">${x.date || ''}</small></span><div style="display:flex; align-items:center;"><b>${toAr(x.amount)}</b>${!x.settled ? `<button onclick="toggleSettle('debt', ${idx})" style="background:none; border:none; cursor:pointer; font-size:18px;">âœ…</button>` : ''}<button class="btn-delete-fancy" onclick="deleteDebt('debt',${idx})">ğŸ—‘ï¸</button></div></div>`),
                ...creditData.map((x,idx)=>`<div class="expense-item animate__animated animate__fadeIn ${x.settled ? 'settled' : ''} ${(x.date && (new Date() - new Date(x.date)) > oneWeek && !x.settled) ? 'debt-alert' : ''}" style="color:var(--accent)"><span>${x.settled ? 'âœ”ï¸' : ''} Ù„Ùƒ Ø¹Ù†Ø¯ ${x.name} <br><small style="font-size:10px; opacity:0.7">${x.date || ''}</small></span><div style="display:flex; align-items:center;"><b>${toAr(x.amount)}</b>${!x.settled ? `<button onclick="toggleSettle('credit', ${idx})" style="background:none; border:none; cursor:pointer; font-size:18px;">âœ…</button>` : ''}<button class="btn-delete-fancy" onclick="deleteDebt('credit',${idx})">ğŸ—‘ï¸</button></div></div>`)
            ].join('');
        } else { document.getElementById('debtDetailsContainer').style.display = 'none'; }
        
        if(typeof myChart !== 'undefined') updateChart();
        const catCtx = document.getElementById('categoryChart').getContext('2d');
        if (myCatChart) myCatChart.destroy();
        myCatChart = new Chart(catCtx, {
            type: 'doughnut', data: { labels: Object.keys(catTotals), datasets: [{ data: Object.values(catTotals), backgroundColor: ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4'], borderWidth: 0, hoverOffset: 10 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: getComputedStyle(document.body).getPropertyValue('--text'), font: { family: 'Tajawal', weight: 'bold' } } } } }
        });

        let topCat = { name: '', amount: 0, pc: 0 };
        for (let cat in catTotals) { if (catTotals[cat] > topCat.amount) topCat = { name: cat, amount: catTotals[cat], pc: (catTotals[cat] / total) * 100 }; }
        document.getElementById('aiAnalysis').innerText = (total > 0 && topCat.amount > 0) ? (topCat.pc > 40 ? `ğŸ’¡ Ø§Ù†ØªØ¨Ù‡: ÙØ¦Ø© (${topCat.name}) ØªØ³ØªÙ‡Ù„Ùƒ ${topCat.pc.toFixed(0)}% Ù…Ù† Ù…ÙŠØ²Ø§Ù†ÙŠØªÙƒ.` : `âœ… ØªÙˆØ²ÙŠØ¹ Ù…Ù…ØªØ§Ø² Ù„Ù…ØµØ§Ø±ÙŠÙÙƒ Ø§Ù„ÙŠÙˆÙ….`) : "Ø³Ø¬Ù„ Ù…ØµØ§Ø±ÙŠÙÙƒ Ø¨Ø§Ù†ØªØ¸Ø§Ù… Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØµØ§Ø¦Ø­.";
    }

    function saveNewGoal() { 
        const name = document.getElementById('newGoalName').value, targetVal = document.getElementById('newGoalTarget').value; 
        const target = safeEval(targetVal);
        if(!name || !target) return; 
        localStorage.setItem('myGoal', JSON.stringify({name, target, current: 0})); 
        document.getElementById('newGoalModal').style.display = 'none'; 
        updateUI(); 
    }

    function addToGoal() { 
        const amtVal = document.getElementById('addGoalAmt').value; 
        const amt = safeEval(amtVal);
        if(!amt) return; 
        let goal = JSON.parse(localStorage.getItem('myGoal')); 
        goal.current += amt; 
        localStorage.setItem('myGoal', JSON.stringify(goal)); 
        document.getElementById('addGoalAmt').value = ''; 
        updateUI(); 
    }

    function resetGoal() { if(confirm("Ø­Ø°Ù Ø§Ù„Ù‡Ø¯ÙØŸ")) { localStorage.removeItem('myGoal'); updateUI(); } }
    function toggleSettle(type, index) { let data = JSON.parse(localStorage.getItem('debt_' + type)); data[index].settled = true; localStorage.setItem('debt_' + type, JSON.stringify(data)); updateUI(); }
    function deleteDebt(m, i) { let d = JSON.parse(localStorage.getItem('debt_'+m)); d.splice(i,1); localStorage.setItem('debt_'+m, JSON.stringify(d)); updateUI(); }
    
    function addItem(idx) { 
        const amtVal = document.getElementById(`amt-${idx}`).value; 
        const a = safeEval(amtVal);
        if(!a) return; 
        const d = JSON.parse(localStorage.getItem(`dayData_${idx}`)) || []; 
        d.push({desc: document.getElementById(`desc-${idx}`).value || 'Ø¹Ø§Ù…', amount: a}); 
        localStorage.setItem(`dayData_${idx}`, JSON.stringify(d)); 
        document.getElementById(`desc-${idx}`).value=''; 
        document.getElementById(`amt-${idx}`).value=''; 
        updateUI(); 
    }

    function deleteItem(d, i) { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")){ let data = JSON.parse(localStorage.getItem(`dayData_${d}`)); data.splice(i, 1); localStorage.setItem(`dayData_${d}`, JSON.stringify(data)); updateUI(); } }
    
    function editItem(dayIdx, itemIdx) { 
        let data = JSON.parse(localStorage.getItem(`dayData_${dayIdx}`)), item = data[itemIdx]; 
        let newDesc = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØµÙ:", item.desc), newAmtVal = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº:", item.amount); 
        const newAmt = safeEval(newAmtVal);
        if (newDesc !== null && newAmt !== null) { 
            data[itemIdx] = { desc: newDesc, amount: newAmt }; 
            localStorage.setItem(`dayData_${dayIdx}`, JSON.stringify(data)); 
            updateUI(); 
        } 
    }

    function checkLock() {
        document.getElementById('daysList').innerHTML = days.map((day, i) => `
            <div class="day-card animate__animated animate__fadeInUp" style="margin: 8px 0; border-radius:18px;">
                <div class="day-header" style="padding:15px; background:var(--bg); color:var(--text); border-bottom:1px solid var(--border);" onclick="toggleElement('day-body-${i}')">
                    <span style="font-weight:700;">${day} â–¾</span>
                    <span id="dayTotal-${i}" style="color:var(--main-c1); font-weight:800;">Ù </span>
                </div>
                <div id="day-body-${i}" style="display:none; padding:15px; background:var(--card-bg);">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:12px;">
                        <input type="text" id="desc-${i}" placeholder="ÙˆØµÙ Ø§Ù„ØµØ±Ù" oninput="handleAutoIcon(${i})">
                        <div style="position:relative;">
                            <input type="text" id="amt-${i}" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                            <span class="calc-icon">ğŸ–©</span>
                        </div>
                    </div>
                    <div class="icon-bar" style="margin-bottom:12px; display:flex; flex-wrap:nowrap; overflow-x:auto; gap:8px; padding-bottom:5px; scrollbar-width: none;">
                        <button class="cat-btn" onclick="setQuickCat(${i}, 'ğŸ´ Ø·Ø¹Ø§Ù…')">ğŸ´ Ø·Ø¹Ø§Ù…</button>
                        <button class="cat-btn" onclick="setQuickCat(${i}, 'ğŸ›’ ØªØ³ÙˆÙ‚')">ğŸ›’ ØªØ³ÙˆÙ‚</button>
                        <button class="cat-btn" onclick="setQuickCat(${i}, 'ğŸš— Ù†Ù‚Ù„')">ğŸš— Ù†Ù‚Ù„</button>
                        <button class="cat-btn" onclick="setQuickCat(${i}, 'ğŸ“± Ø±ØµÙŠØ¯')">ğŸ“± Ø±ØµÙŠØ¯</button>
                    </div>
                    <button onclick="addItem(${i})" class="btn-add-pro" style="width:100%; margin:0;">+ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
                    <div id="items-${i}" style="margin-top:15px;"></div> </div>
            </div>`).join('');
        updateUI();
    }
    
    function setQuickCat(idx, cat) { document.getElementById(`desc-${idx}`).value = cat; }
    function applyColor(c1, c2) { document.documentElement.style.setProperty('--main-c1', c1); document.documentElement.style.setProperty('--main-c2', c2); localStorage.setItem('userC1', c1); localStorage.setItem('userC2', c2); updateUI(); }
    function toggleTheme() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); updateUI(); }
    function toggleGhostMode() { document.body.classList.toggle('ghost-mode'); }
    function toggleSearch() { const s = document.getElementById('searchBar'); s.style.display = (s.style.display === 'block') ? 'none' : 'block'; }
    function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function openPinModal() { document.getElementById('pinModal').style.display='flex'; }
    function saveNewPin() { localStorage.setItem('appPin', document.getElementById('newPinInput').value); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯!"); document.getElementById('pinModal').style.display='none'; }
    function openDebtModal(m) { currentDebtMode = m; document.getElementById('debtModal').style.display='flex'; }
    function closeDebtModal() { document.getElementById('debtModal').style.display='none'; }
    
    function saveDebtRecord() { 
        const n = document.getElementById('debtName').value, amtVal = document.getElementById('debtAmount').value; 
        const a = safeEval(amtVal);
        if(!n || !a) return; 
        let data = JSON.parse(localStorage.getItem('debt_'+currentDebtMode)) || []; 
        data.push({name:n, amount:a, settled: false, date: new Date().toISOString().split('T')[0]}); 
        localStorage.setItem('debt_'+currentDebtMode, JSON.stringify(data)); 
        closeDebtModal(); 
        updateUI(); 
    }

    function editBrandName() { document.getElementById('editBrandModal').style.display = 'flex'; }
    function closeEditBrandModal() { document.getElementById('editBrandModal').style.display = 'none'; }
    function saveBrand() { localStorage.setItem('customAppName', document.getElementById('newNameInput').value); localStorage.setItem('customAppLogo', document.getElementById('newLogoInput').value); location.reload(); }
    function exportAsImage() { html2canvas(document.querySelector("#captureArea")).then(c => { const a = document.createElement('a'); a.download = 'Ù…ØµØ§Ø±ÙŠÙÙŠ.png'; a.href = c.toDataURL(); a.click(); }); }
    function backupData() { let d = {}; for(let i=0; i<localStorage.length; i++) d[localStorage.key(i)] = localStorage.getItem(localStorage.key(i)); const b = new Blob([JSON.stringify(d)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'backup.json'; a.click(); }
    function restoreData(event) { const r = new FileReader(); r.onload = (x) => { const d = JSON.parse(x.target.result); localStorage.clear(); for(const k in d) localStorage.setItem(k, d[k]); location.reload(); }; r.readAsText(event.target.files[0]); }
    function resetWeek() { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒØ§ÙØ© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ.")) { days.forEach((_, i) => localStorage.removeItem(`dayData_${i}`)); localStorage.removeItem('fixedExpenses'); location.reload(); } }
</script>
</body>
</html>
